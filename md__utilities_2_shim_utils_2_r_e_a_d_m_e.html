<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenCore: OpenCore + OpenLinuxBoot + Secure Boot</title>
<link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-zephyr.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-zephyr.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="LogoApprox.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OpenCore
   &#160;<span id="projectnumber">1.0.4</span>
   </div>
   <div id="projectbrief">OpenCore Bootloader</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__utilities_2_shim_utils_2_r_e_a_d_m_e.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">OpenCore + OpenLinuxBoot + Secure Boot</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md154"></a></p>
<p>If you want to use OpenCore + OpenLinuxBoot + Secure Boot it is possible to sign everything manually yourself, including any new Linux kernels after updates. This is possible since most standard distros leave at least the previous kernel bootable (and OpenLinuxBoot exposes this, via the Auxiliary menu), so you can boot into the old kernel, then sign the new kernel yourself.</p>
<p>More convenient may be to trust the signing keys of the specific distros which you want to boot, which are bundled into the <code>shimx64.efi</code> file installed with each distro. You can extract these with <code>shim-to-cert.tool</code> distributed with OpenCore, then install them in your system Secure Boot <code>db</code> variable. Best practice would be to install the deny list (<code>vendor.dbx</code>) from <code>shimx64.efi</code>, if any, into your system <code>dbx</code> variable, as well. (Otherwise you are ignoring any revocations which the vendor has made.)</p>
<p>Recently, Shim has added SBAT support, as a more efficient way to revoke unsafe binaries. Unfortunately, the SBAT enforcement code is part of Shim, and is not something you can extract and add to your system Secure Boot database.</p>
<p>To work round this, the new recommended way to boot OpenCore + OpenLinuxBoot + Secure Boot is to make a user build of Shim. The vendor certificates and revocation lists extracted from the distro <code>shimx64.efi</code> files are combined and signed by you, into your own build of Shim; in this approach, these vendor certificates should NOT also be included in the system Secure Boot database, and should be removed if you added them previously. Including them in both places will still boot under Secure Boot, but will effectively disable SBAT revocation.</p>
<blockquote class="doxtable">
<p>&zwj;If you are signing everything yourself, including Linux kernels after updates, that will still work as before and the below is not needed. Equally, if you are not using Secure Boot the below is not needed. </p>
</blockquote>
<p>The advantages of using a user build of Shim are:</p><ul>
<li>No need to sign every kernel after updates (same as previous method)</li>
<li>Linux SBAT integration (new)</li>
<li>Linux MOK integration (new)</li>
<li>No need to include the Windows intermediate CA - you are trusting whichever distro keys you choose to include in your own Shim, directly (new)</li>
</ul>
<p>Disadvantages are:</p><ul>
<li>Need to update when distro keys or distro revocation lists within Shim are updated (same as previous method)</li>
<li>Need to udpate when Shim SBAT level is updated (new)</li>
</ul>
<h2><a class="anchor" id="autotoc_md155"></a>
Method</h2>
<p><code>Utilities/ShimUtils</code> includes a script <code>shim-make.tool</code> which will download the current Shim source and build it for you, on macOS (using Ubuntu multipass) or on Linux (Ubuntu and Fedora supported, others may work).</p>
<ul>
<li>Extract <code>vendor.db</code> and <code>vendor.dbx</code> files from the <code>shimx64.efi</code> file of each distro which you want to load (using <code>shim-to-cert.tool</code>)<ul>
<li>For non-GRUB distros, the required public keys for this process cannot be extracted from <code>shimx64.efi</code> and so must be found by additional user research</li>
</ul>
</li>
<li>Concatentate these (e.g. <code>cat fedora/vendor.db ubuntu/vendor.db &gt; combined/vendor.db</code> and <code>cat fedora/vendor.dbx ubuntu/vendor.dbx &gt; combined/vendor.dbx</code>)<ul>
<li>Do not concatenate <code>.der</code> files directly, it will not work</li>
<li>If you have a single distro with a single <code>.der</code> file, you can use <code>VENDOR_CERT_FILE</code> instead of <code>VENDOR_DB_FILE</code> in the <code>make</code> options below; otherwise, you will need to use <code>cert-to-efi-sig-list</code> from <code>efitools</code> to convert the <code>.der</code> file to a sig list - this is done automatically by <code>shim-to-cert.tool</code> when <code>efitools</code> are available (in Linux; or from within Ubuntu multipass on macOS, e.g. <code>multipass shell oc-shim</code>)</li>
</ul>
</li>
<li>Build a version of Shim which includes these concatenated signature lists (and launches OpenCore.efi directly):<ul>
<li><code>./shim-make.tool setup</code></li>
<li><code>./shim-make.tool clean</code> (only needed if remaking after the initial make)</li>
<li><code>./shim-make.tool make VENDOR_DB_FILE={full-path-to}/vendor.db VENDOR_DBX_FILE={full-path-to}/vendor.dbx</code><ul>
<li>On macOS, the paths to these files must either be within the multipass VM, or within a subdirectory visible to macOS and the VM on the same path, such as <code>/Users/{username}/shim_root</code> when using <code>shim-make.tool</code> default settings</li>
</ul>
</li>
</ul>
</li>
<li>Copy the relevant files (<code>shimx64.efi</code> and <code>mmx64.efi</code> as well as <code>BOOTX64.CSV</code>) to your mounted ESP volume, e.g.:<ul>
<li><code>./shim-make.tool install /Volumes/EFI</code> (macOS)</li>
<li><code>sudo ./shim-make.tool install /boot/efi</code> (Linux)</li>
</ul>
</li>
<li>Sign the newly built <code>shimx64.efi</code> and <code>mmx64.efi</code> with your own ISK (see e.g. <a href="https://habr.com/en/articles/273497/">https://habr.com/en/articles/273497/</a> - Google translate is your friend)<ul>
<li>If you do not copy and sign <code>mmx64.efi</code> as well as <code>shimx64.efi</code>, your system will hang if any MOK operations are attempted</li>
<li><code>BOOTX64.CSV</code> is not required and is for information only</li>
</ul>
</li>
</ul>
<p>As before you need to sign <code>OpenCore.efi</code> and any drivers it loads with your ISK. You now also need to add an empty SBAT section to <code>OpenCore.efi</code> before signing it.</p>
<blockquote class="doxtable">
<p>&zwj;An empty SBAT section means: 'I'm not part of the system which allocates SBAT names and signs them into boot files, and I don't want this boot file to be revoked by any future SBAT revocations'. Of course, you can still revoke boot files you signed yourself by rotating your own signing keys. </p>
</blockquote>
<p>As noted <a href="https://github.com/fwupd/fwupd/issues/2910">here</a> and <a href="https://github.com/rhboot/shim/issues/376">here</a>, the <a href="https://github.com/rhboot/shim/blob/main/SBAT.md">documented</a> method for adding an SBAT section to an already-linked <code>.efi</code> file does not work correctly (GNU <code>objcopy</code> corrupts the executable). This <a href="https://github.com/rhboot/shim/issues/376#issuecomment-1628004034">third party python script</a> does work. A suitable command is:</p>
<p><code>pe-add-sections.py -s .sbat &lt;(echo -n) -z .sbat -i OpenCore.efi -o OpenCore_empty_sbat.efi</code></p>
<p>This file then needs to be signed and copied back into place, e.g.:</p>
<p><code>sbsign --key {path-to}/ISK.key --cert {path-to}/ISK.pem OpenCore_empty_sbat.efi --output OpenCore.efi</code></p>
<p>Finally, in order for OpenCore integration with Shim to work correctly <code>UEFI/Quirks/ShimRetainProtocol</code> must be enabled in <code>config.plist</code>, and <code>LauncherPath</code> should be set to <code>\EFI\OC\shimx64.efi</code>.</p>
<blockquote class="doxtable">
<p>&zwj;Using Ubuntu multipass, it is now possible to operate entirely within macOS for signing, key generation, etc. Note that the <code>~/shim_root</code> directory is already shared between macOS and the <code>oc-shim</code> multipass VM (under its macOS path, e.g. <code>/Users/username/shim_root</code>), and other macOS folders and volumes can be mounted if you wish, e.g. <code>multipass mount /Volumes/EFI oc-shim:/Volumes/EFI</code>. </p>
</blockquote>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
<script type="text/javascript">
  $(function() {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    // every resize will remove the button, which is why it has to be added again:
    $(window).resize(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>
