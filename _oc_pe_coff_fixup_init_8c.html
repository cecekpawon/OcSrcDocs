<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenCore: Library/OcPeCoffExtLib/OcPeCoffFixupInit.c File Reference</title>
<link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-zephyr.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-zephyr.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="LogoApprox.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OpenCore
   &#160;<span id="projectnumber">1.0.4</span>
   </div>
   <div id="projectbrief">OpenCore Bootloader</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_oc_pe_coff_fixup_init_8c.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">OcPeCoffFixupInit.c File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;Base.h&gt;</code><br />
<code>#include &lt;Uefi/UefiBaseType.h&gt;</code><br />
<code>#include &lt;IndustryStandard/PeImage2.h&gt;</code><br />
<code>#include &lt;Guid/WinCertificate.h&gt;</code><br />
<code>#include &lt;Library/BaseMemoryLib.h&gt;</code><br />
<code>#include &lt;Library/BaseOverflowLib.h&gt;</code><br />
<code>#include &lt;Library/DebugLib.h&gt;</code><br />
<code>#include &lt;Library/PcdLib.h&gt;</code><br />
<code>#include &lt;Library/PeCoffLib2.h&gt;</code><br />
<code>#include &lt;<a class="el" href="_oc_string_lib_8h_source.html">Library/OcStringLib.h</a>&gt;</code><br />
<code>#include &quot;<a class="el" href="_base_pe_coff_lib2_internals_8h_source.html">BasePeCoffLib2Internals.h</a>&quot;</code><br />
</div>
<p><a href="_oc_pe_coff_fixup_init_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:aa54bfd8b4a1714b7d4f3caf7ef028307" id="r_aa54bfd8b4a1714b7d4f3caf7ef028307"><td class="memItemLeft" align="right" valign="top">STATIC RETURN_STATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aa54bfd8b4a1714b7d4f3caf7ef028307">InternalVerifySections</a> (IN OUT PE_COFF_LOADER_IMAGE_CONTEXT *Context, IN UINT32 FileSize, OUT UINT32 *<a class="el" href="_apple_sm_bios_8h.html#a34463dacac1fc89a9dbd90d55e141d7d">StartAddress</a>, IN BOOLEAN InMemoryFixup)</td></tr>
<tr class="separator:aa54bfd8b4a1714b7d4f3caf7ef028307"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0bbd7947bd01f30d3ff812e028024bf9" id="r_a0bbd7947bd01f30d3ff812e028024bf9"><td class="memItemLeft" align="right" valign="top">STATIC RETURN_STATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a0bbd7947bd01f30d3ff812e028024bf9">InternalValidateRelocInfo</a> (IN CONST PE_COFF_LOADER_IMAGE_CONTEXT *Context, IN UINT32 <a class="el" href="_apple_sm_bios_8h.html#a34463dacac1fc89a9dbd90d55e141d7d">StartAddress</a>)</td></tr>
<tr class="separator:a0bbd7947bd01f30d3ff812e028024bf9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaebf2ce29d6f22ede1deab7a22419708" id="r_aaebf2ce29d6f22ede1deab7a22419708"><td class="memItemLeft" align="right" valign="top">STATIC RETURN_STATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aaebf2ce29d6f22ede1deab7a22419708">InternalInitializePe</a> (IN OUT PE_COFF_LOADER_IMAGE_CONTEXT *Context, IN UINT32 FileSize, IN BOOLEAN InMemoryFixup)</td></tr>
<tr class="separator:aaebf2ce29d6f22ede1deab7a22419708"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae40e3e76ab0212f78b7598b7f8027434" id="r_ae40e3e76ab0212f78b7598b7f8027434"><td class="memItemLeft" align="right" valign="top">RETURN_STATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ae40e3e76ab0212f78b7598b7f8027434">OcPeCoffFixupInitializeContext</a> (OUT PE_COFF_LOADER_IMAGE_CONTEXT *Context, IN CONST VOID *FileBuffer, IN UINT32 FileSize, IN BOOLEAN InMemoryFixup)</td></tr>
<tr class="separator:ae40e3e76ab0212f78b7598b7f8027434"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implements APIs to fix certain issues in legacy EFI files in memory before loading.</p>
<p>Very closely based on MdePkg/Library/BasePeCoffLib2/PeCoffInit.c, and intentionally kept more similar to that file than it would otherwise need to be, to easily allow diffing and importing future changes if required.</p>
<p>Copyright (c) 2023, Mike Beaton, Vitaly Cheptsov. All rights reserved.<br  />
 Copyright (c) 2020 - 2021, Marvin HÃ¤user. All rights reserved.<br  />
 Copyright (c) 2020, Vitaly Cheptsov. All rights reserved.<br  />
 Copyright (c) 2020, ISP RAS. All rights reserved.<br  />
 Portions copyright (c) 2006 - 2019, Intel Corporation. All rights reserved.<br  />
 Portions copyright (c) 2008 - 2010, Apple Inc. All rights reserved.<br  />
 Portions copyright (c) 2020, Hewlett Packard Enterprise Development LP. All rights reserved.<br  />
</p>
<p>SPDX-License-Identifier: BSD-3-Clause </p>

<p class="definition">Definition in file <a class="el" href="_oc_pe_coff_fixup_init_8c_source.html">OcPeCoffFixupInit.c</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="aaebf2ce29d6f22ede1deab7a22419708" name="aaebf2ce29d6f22ede1deab7a22419708"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaebf2ce29d6f22ede1deab7a22419708">&#9670;&#160;</a></span>InternalInitializePe()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">STATIC RETURN_STATUS InternalInitializePe </td>
          <td>(</td>
          <td class="paramtype">IN OUT PE_COFF_LOADER_IMAGE_CONTEXT *</td>          <td class="paramname"><span class="paramname"><em>Context</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IN UINT32</td>          <td class="paramname"><span class="paramname"><em>FileSize</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IN BOOLEAN</td>          <td class="paramname"><span class="paramname"><em>InMemoryFixup</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Verify the PE32 or PE32+ Image and initialise Context.</p>
<p>Used offsets and ranges must be aligned and in the bounds of the raw file. Image section Headers and basic Relocation information must be Well-formed.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">Context</td><td>The context describing the Image. Must have been initialised by PeCoffInitializeContext(). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">FileSize</td><td>The size, in Bytes, of Context-&gt;FileBuffer. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">InMemoryFixup</td><td>If TRUE, fixes are made to image in memory. If FALSE, Context is initialised as if fixes were made, but no changes are made to loaded image.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">RETURN_SUCCESS</td><td>The PE Image is Well-formed. </td></tr>
    <tr><td class="paramname">other</td><td>The PE Image is malformed. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="_oc_pe_coff_fixup_init_8c_source.html#l00409">409</a> of file <a class="el" href="_oc_pe_coff_fixup_init_8c_source.html">OcPeCoffFixupInit.c</a>.</p>

</div>
</div>
<a id="a0bbd7947bd01f30d3ff812e028024bf9" name="a0bbd7947bd01f30d3ff812e028024bf9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0bbd7947bd01f30d3ff812e028024bf9">&#9670;&#160;</a></span>InternalValidateRelocInfo()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">STATIC RETURN_STATUS InternalValidateRelocInfo </td>
          <td>(</td>
          <td class="paramtype">IN CONST PE_COFF_LOADER_IMAGE_CONTEXT *</td>          <td class="paramname"><span class="paramname"><em>Context</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IN UINT32</td>          <td class="paramname"><span class="paramname"><em>StartAddress</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Verify the basic Image Relocation information.</p>
<p>The preferred Image load address must be aligned by the section alignment. The Relocation Directory must be contained within the Image section memory. The Relocation Directory must be sufficiently aligned in memory.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">Context</td><td>The context describing the Image. Must have been initialised by PeCoffInitializeContext(). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">StartAddress</td><td>The RVA of the first Image section.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">RETURN_SUCCESS</td><td>The basic Image Relocation information is well-formed. </td></tr>
    <tr><td class="paramname">other</td><td>The basic Image Relocation information is malformed. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="_oc_pe_coff_fixup_init_8c_source.html#l00327">327</a> of file <a class="el" href="_oc_pe_coff_fixup_init_8c_source.html">OcPeCoffFixupInit.c</a>.</p>

</div>
</div>
<a id="aa54bfd8b4a1714b7d4f3caf7ef028307" name="aa54bfd8b4a1714b7d4f3caf7ef028307"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa54bfd8b4a1714b7d4f3caf7ef028307">&#9670;&#160;</a></span>InternalVerifySections()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">STATIC RETURN_STATUS InternalVerifySections </td>
          <td>(</td>
          <td class="paramtype">IN OUT PE_COFF_LOADER_IMAGE_CONTEXT *</td>          <td class="paramname"><span class="paramname"><em>Context</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IN UINT32</td>          <td class="paramname"><span class="paramname"><em>FileSize</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">OUT UINT32 *</td>          <td class="paramname"><span class="paramname"><em>StartAddress</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IN BOOLEAN</td>          <td class="paramname"><span class="paramname"><em>InMemoryFixup</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Verify the Image section Headers and initialise the Image memory space size.</p>
<p>The first Image section must be the beginning of the memory space, or be contiguous to the aligned Image Headers. Sections must be disjoint and, depending on the policy, contiguous in the memory space space. The section data must be in bounds bounds of the file buffer.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">Context</td><td>The context describing the Image. Must have been initialised by PeCoffInitializeContext(). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">FileSize</td><td>The size, in Bytes, of Context-&gt;FileBuffer. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">StartAddress</td><td>On output, the RVA of the first Image section. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">InMemoryFixup</td><td>If TRUE, fixes are made to image in memory. If FALSE, Context is initialised as if fixes were made, but no changes are made to loaded image.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">RETURN_SUCCESS</td><td>The Image section Headers are well-formed. </td></tr>
    <tr><td class="paramname">other</td><td>The Image section Headers are malformed. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="_oc_pe_coff_fixup_init_8c_source.html#l00061">61</a> of file <a class="el" href="_oc_pe_coff_fixup_init_8c_source.html">OcPeCoffFixupInit.c</a>.</p>

</div>
</div>
<a id="ae40e3e76ab0212f78b7598b7f8027434" name="ae40e3e76ab0212f78b7598b7f8027434"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae40e3e76ab0212f78b7598b7f8027434">&#9670;&#160;</a></span>OcPeCoffFixupInitializeContext()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">RETURN_STATUS OcPeCoffFixupInitializeContext </td>
          <td>(</td>
          <td class="paramtype">OUT PE_COFF_LOADER_IMAGE_CONTEXT *</td>          <td class="paramname"><span class="paramname"><em>Context</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IN CONST VOID *</td>          <td class="paramname"><span class="paramname"><em>FileBuffer</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IN UINT32</td>          <td class="paramname"><span class="paramname"><em>FileSize</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IN BOOLEAN</td>          <td class="paramname"><span class="paramname"><em>InMemoryFixup</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Fix W^X and section overlap issues in loaded TE, PE32, or PE32+ Image in memory while initialising Context.</p>
<p>Closely based on PeCoffInitializeContext from PeCoffLib2.</p>
<p>The approach of modifying the image in memory is basically incompatible with secure boot, although: a) Certain firmware may allow optionally registering the hash of any image which does not load, which would still work. b) It is fairly crazy anyway to want to apply secure boot to the old, insecure .efi files which need these fixups.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">Context</td><td>The context describing the Image. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">FileBuffer</td><td>The file data to parse as PE Image. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">FileSize</td><td>The size, in Bytes, of FileBuffer. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">InMemoryFixup</td><td>If TRUE, fixes are made to image in memory. If FALSE, Context is initialised as if fixes were made, but no changes are made to loaded image.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">RETURN_SUCCESS</td><td>The Image context has been initialised successfully. </td></tr>
    <tr><td class="paramname">other</td><td>The file data is malformed. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="_oc_pe_coff_fixup_init_8c_source.html#l00739">739</a> of file <a class="el" href="_oc_pe_coff_fixup_init_8c_source.html">OcPeCoffFixupInit.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5ad7f572bbca03234e8e621e192fc099.html">Library</a></li><li class="navelem"><a class="el" href="dir_0f006894a49824c52c6f78675735280d.html">OcPeCoffExtLib</a></li><li class="navelem"><a class="el" href="_oc_pe_coff_fixup_init_8c.html">OcPeCoffFixupInit.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
<script type="text/javascript">
  $(function() {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    // every resize will remove the button, which is why it has to be added again:
    $(window).resize(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>
