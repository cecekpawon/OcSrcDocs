<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenCore: Provides standalone GOP driver for EFI era Mac Pro and iMac</title>
<link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-zephyr.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-zephyr.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="LogoApprox.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OpenCore
   &#160;<span id="projectnumber">1.0.4</span>
   </div>
   <div id="projectbrief">OpenCore Bootloader</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__staging_2_enable_gop_2_r_e_a_d_m_e.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Provides standalone GOP driver for EFI era Mac Pro and iMac</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md75"></a></p>
<h1><a class="anchor" id="autotoc_md76"></a>
Releases</h1>
<p>EnableGop version (OpenCore version)</p>
<h2><a class="anchor" id="autotoc_md77"></a>
1.4 (0.9.3)</h2>
<ul>
<li>Incorporates recent updates to OpenCore console control code, but no difference in behaviour compared to version 1.3 is expected on any supported systems.</li>
</ul>
<h2><a class="anchor" id="autotoc_md78"></a>
1.3 (0.9.2)</h2>
<ul>
<li>Included fix to GopBurstMode for non-standard frame buffer information on AMD Radeon HD 7970 and similar</li>
<li>Applied GopBurstMode even on natively supported cards, as it can provide a noticable speed up</li>
</ul>
<h2><a class="anchor" id="autotoc_md79"></a>
1.2 (0.9.1)</h2>
<ul>
<li>Added GopBurstMode support</li>
</ul>
<p><em>Note 1</em>: This should provide faster GOP rendering on all EnableGopDirect systems; and rendering at least at the same speed as before, and on some systems noticeably faster than before, on almost all EnableGop systems.</p>
<p><em>Note 2</em>: The compressed driver for version 1.2 is 1KB larger than for version 1.1, so for AMD GPU firmware which is tight on space version 1.1 may be used instead to avoid the need for VGA stripping to make additional space.</p>
<h2><a class="anchor" id="autotoc_md80"></a>
1.1 (0.9.0)</h2>
<ul>
<li>Fixed early verbose boot lines appearing over picker</li>
<li>Added EnableGop version number to UI section</li>
</ul>
<h2><a class="anchor" id="autotoc_md81"></a>
1.0 (0.8.9)</h2>
<ul>
<li>Initial public release</li>
</ul>
<h1><a class="anchor" id="autotoc_md82"></a>
Status</h1>
<p><b>Current status: Beta release.</b></p>
<p>This driver has been tested and is working on several iMac models with several different GPUs, and on several MacPro4,1/5,1 machines with several different GPUs. However, in the worst case (and still possible) scenario, an incompatible or incorrectly installed driver in firmware may brick your hardware.</p>
<p><em>In all cases take a backup of the main firmware or GPU firmware which you are modifying, and confirm that you can successfully restore from this, before starting.</em></p>
<h1><a class="anchor" id="autotoc_md83"></a>
Recovery from bricked hardware</h1>
<ul>
<li>If attempting main firmware insertion on a MacPro4,1/5,1, for recovery from a bricked device you will either need a Matt card (which may breach intellectual property laws in some jurisdictions) or the ability to desolder and reprogram your own SPI flash chip.</li>
<li>If testing via main firmware insertion on an iMac, you will need the ability to disassemble your iMac and reprogram its SPI flash chip using a SOIC clip attached to a CH341A controller running on another computer.</li>
<li>If testing via GPU firmware insertion (iMac or Mac Pro), you will need the ability to disassemble your system, likely remove the heat sink from the graphics card, and then reprogram its SPI flash chip using a SOIC clip attached to a CH341A controller running on another computer.<ul>
<li>If testing via GPU firmware insertion, in some cases it may also be possible to use physical electrical connection to your GPU in order to enable booting with no graphics even though the GPU is present, then connect to your machine with <code>ssh</code> (which must have been enabled beforehand) and reprogram the GPU firmware. Advice on this headless boot approach is not provided here, but may be found for instance on the iMac GPU related forum threads listed below.</li>
</ul>
</li>
</ul>
<p><em>If you are not familiar with the above procedures, you are strongly recommended to wait for further testing by users who are. No further help can be provided here, and you proceed entirely at your own risk.</em></p>
<h1><a class="anchor" id="autotoc_md84"></a>
Summary</h1>
<p>Targetting EFI-era (~2009-2012) MacPro4,1/5,1 and iMac firmware, this driver gathers and injects the parts of OpenCore needed for pre-boot graphics support with non-natively supported GPUs.</p>
<p>The requirements for using this driver are:</p>
<ul>
<li>EFI-era (~2009-2012) MacPro4,1/5,1 or iMac with most recent main firmware.</li>
<li>A GPU which does not produce native pre-boot graphics (such as native picker when pressing ALT key during boot) before OpenCore starts (otherwise, you do not need it).</li>
<li>A GPU which produces graphics when using OpenCore (this must include successfully showing the native Apple boot picker when started via the latest version of OpenCore tool <code>BootKicker.efi</code>) (otherwise, the driver will not work).<ul>
<li><em>Note</em>: If your OpenCore installation includes a required GOP driver for your graphics card, then you would also need to burn that driver to the firmware of your graphics card in order to obtain pre-OpenCore graphics; instructions for this are outside the scope of this tutorial, although the procedures required for modifying GPU firmware are similar to what is covered here. Note that such a driver is added by the OCLP <b>Enable AMD GOP</b> option, which is enabled automatically on some systems by recent versions of OpenCore Legacy Patcher, as a way to enable the OpenCore menu in cards such as ex-mining GPUs.</li>
</ul>
</li>
</ul>
<p>When installed, the driver should enable:</p>
<ul>
<li>Native boot picker via ALT key</li>
<li>Firmware password UI</li>
<li>Target disk mode UI</li>
<li>macOS boot progress screen</li>
<li>etc.</li>
</ul>
<p>Compiled versions of the driver files and these instructions may be found in the <code>Utilities/EnableGop</code> directory of the OpenCore release package.</p>
<p>For GPUs needing <code>DirectGopRendering</code> in OpenCore configuration, use <code>EnableGopDirect.efi</code>, otherwise use <code>EnableGop.efi</code> as it renders faster on most other systems.</p>
<p>The driver may be installed to GPU or main motherboard firmware. It is expected that most Mac Pro users will use main firmware insertion and most iMac users will chose GPU firmware insertion, however both techniques work on both systems (but it is harder to modify the iMac main firmware, since there is no simple way to enable writing to it).</p>
<p>Further discussion and community support for this driver is available at:</p>
<ul>
<li><a href="https://forums.macrumors.com/threads/pre-opencore-gop-support-for-efi-era-imacs-and-mac-pros.2378942/">https://forums.macrumors.com/threads/pre-opencore-gop-support-for-efi-era-imacs-and-mac-pros.2378942/</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md85"></a>
Usage</h1>
<h1><a class="anchor" id="autotoc_md86"></a>
Install to main firmware</h1>
<p>For reading and writing to main firmware on the Mac Pro, @Macschrauber's <a href="https://github.com/Macschrauber/Macschrauber-s-Rom-Dump">Rom Dump</a> works well. Alternatively the kexts and executables which this uses can be sourced individually (or extracted from the Rom Dump app) and run from the command line.</p>
<p>The main firmware on the iMac cannot be updated without an initial hardware flash (SOIC clip plus CH341A controller), therefore the recommended approach on iMac systems is GPU firmware injection. However, the below instructions for firmware injection do work, if you are willing to do a hardware flash of the resulting firmware file, or if you have already <a href="https://forums.macrumors.com/threads/imac-2011-see-more-uefi-firmware-mod.2257435/page-3?post=31087001#post-31087001">unprotected your iMac firmware</a> - which reduces security, and is only recommended for those actively developing firmware modifications.</p>
<p>The <code>.ffs</code> file provided in this directory can be manually added to the extracted firmware file using <a href="https://github.com/LongSoft/UEFITool"><code>UEFITool</code></a>, or automatically added using @dosdude1's <a href="https://dosdude1.com/apps/"><code>DXEInject</code></a>. Once more, if you are not familiar with these procedures, you are recommended to proceed with extreme caution.</p>
<h2><a class="anchor" id="autotoc_md87"></a>
Using DXEInject</h2>
<p>To install the driver via <code>DXEInject</code>, the command is:</p>
<ul>
<li><code>DXEInject {original}.rom {modified}.rom EnableGop.ffs</code></li>
</ul>
<p>The file <code>{modifed}.rom</code> is ready for burning, although the result can be checked using UEFITool, if required.</p>
<blockquote class="doxtable">
<p>&zwj;<em>Note</em>: If only reading a file with UEFITool, the latest version is recommended, as it provides the most information. For writing, the older version 0.25.1 must be used, as described below. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md88"></a>
Using UEFITool</h2>
<p>The <code>.ffs</code> file may be inserted anywhere within the same firmware volume which contains <code>DuetBds</code> (file GUID <code>A6F691AC-31C8-4444-854C-E2C1A6950F92</code>). However, for simplicity, these instructions will insert it in the same place that <code>DXEInject</code> does:</p>
<ul>
<li>Use UEFITool 0.25.1 (it must be that old version, not the newer NE or new engine versions, which cannot yet edit)</li>
<li>Perform a header-only GUID search for <code>BAE7599F-3C6B-43B7-BDF0-9CE07AA91AA6</code></li>
<li>Double-click on the search result</li>
<li>Right-click on the DXE driver with that GUID which should then appear</li>
<li>Choose "Insert after..." and select <code>EnableGop.ffs</code></li>
<li>Save the modified firmware</li>
</ul>
<p>The end result, after saving and re-loading, should look like this:</p>
<p><img src="UEFITool_Inserted_Screenshot.png" alt="" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md89"></a>
Install to GPU firmware</h1>
<p>Instructions and a script for inserting the driver into Nvidia or AMD GPU firmware (aka VBIOS) are provided.</p>
<p>Please note all the cautions already given above about the difficulty of recovering, unless you are familiar with the procedures necessary, if this process fails.</p>
<p>To use the provided <code>vBiosInsert.sh</code> script:</p>
<ul>
<li>Locate an appropriate version of the <code>nvflash</code> tool (Nvidia) or <code>amdvbflash</code> tool (AMD) (both are available for Linux and Windows), which can be used to read from and write to the GPU firmware.</li>
<li>Use that tool to read a copy of the GPU firmware.</li>
<li>Run <code>./vBiosInsert.sh [-a|-n] {original}.rom EnableGop.efi {modified}.rom</code>, with <code>-a</code> for AMD and <code>-n</code> for Nvidia.<ul>
<li>If you have any problems with <code>vBiosInsert.sh</code> from a specific release of EnableGop, please try the version included with the latest release of OpenCore before reporting any issues. The script receives updates to support additional graphics cards independently of any bumps to the release version of EnableGop. If you need to, you can use the latest version of <code>vBiosInsert.sh</code> to inject older versions of EnableGop.</li>
</ul>
</li>
<li>The new file <code>{modified}.rom</code> may be burnt to the GPU firmware.</li>
</ul>
<p>In the case of AMD, considerably less space is normally available, due to a strict limit of 128k for legacy and EFI parts of the larger ROM image. If there is not enough space (i.e. script reports data would be truncated) then it is necessary to <a href="https://github.com/Ausdauersportler/IMAC-EFI-BOOT-SCREEN/wiki/Deleting-the-VGA">strip some legacy VGA parts of the GPU firmware</a>. This is beyond the scope of these instructions.</p>
<p>If required to manually detect the GOP offset (this should normally be autodetected):</p>
<blockquote class="doxtable">
<p>&zwj;Using a hex editor, search in the GPU firmware dump for the byte sequence <code>F1 0E 00 00</code> with the byte sequence <code>55 AA</code> coming close before it; the start address of the <code>55 AA</code> is the GOP offset value needed. </p>
</blockquote>
<p>For further information on GPU firmware modification, see:</p>
<ul>
<li><a href="https://forums.macrumors.com/threads/2011-imac-graphics-card-upgrade.1596614/">https://forums.macrumors.com/threads/2011-imac-graphics-card-upgrade.1596614/</a></li>
<li><a href="https://forums.macrumors.com/threads/imac-2011-maxwell-and-pascal-gpu-upgrade.2300989/">https://forums.macrumors.com/threads/imac-2011-maxwell-and-pascal-gpu-upgrade.2300989/</a></li>
<li><a href="https://github.com/Ausdauersportler/IMAC-EFI-BOOT-SCREEN/wiki">https://github.com/Ausdauersportler/IMAC-EFI-BOOT-SCREEN/wiki</a></li>
<li><a href="https://winraid.level1techs.com/t/amd-and-nvidia-gop-update-no-requests-diy/30917">https://winraid.level1techs.com/t/amd-and-nvidia-gop-update-no-requests-diy/30917</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
<script type="text/javascript">
  $(function() {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    // every resize will remove the button, which is why it has to be added again:
    $(window).resize(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>
